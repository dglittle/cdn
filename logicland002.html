<script src="https://www.gstatic.com/firebasejs/3.9.0/firebase.js"></script>
<body style="margin:0px"></body>
<script>

var PALETTE_HEIGHT = 50

var config = {
    apiKey: "AIzaSyDVM0ekHwUqC_rGsqkT7fJ71FyRum9cxko",
    authDomain: "glittle.firebaseapp.com",
    databaseURL: "https://glittle.firebaseio.com",
    projectId: "glittle",
    storageBucket: "",
    messagingSenderId: "1000468536093"
}
var db = firebase.initializeApp(config).database().ref()

db.child('/aa/test_node/logicland002').once('value', function (x) {
    x = x.val()
    console.log('got heeree!! x=', x)
    each(x, function (v, k) {
        model[k] = v
    })
    render()
}, function (x) {
    console.log('bad news! blah_hkjcuqpbnv...')
    console.log(x)
})

var model = {
    view : {
        scale : 16
    },
    brush : 'wire',
    version : 0,
    wires : {}, // { x: , y: , charge: , version: }
    gates : {}  // { x: , y: , type: }
}

function draw_palette() {
    var d = document.createElement('div')
    d.style.width = '100%'
    d.style.height = PALETTE_HEIGHT + 'px'
    
    d.textContent = 'hi there!'
    
    var b = document.createElement('button')
    b.style.width = PALETTE_HEIGHT + 'px'
    b.style.height = PALETTE_HEIGHT + 'px'
    b.textContent = '+'
    b.onclick = function () {
        model.view.scale *= 2
        render()
    }
    d.append(b)
    
    var b = document.createElement('button')
    b.style.width = PALETTE_HEIGHT + 'px'
    b.style.height = PALETTE_HEIGHT + 'px'
    b.textContent = '-'
    b.onclick = function () {
        model.view.scale /= 2
        render()
    }
    d.append(b)
    
    // radio buttons
    var radio_buttons = []

    var b = document.createElement('button')
    b.style.width = PALETTE_HEIGHT + 'px'
    b.style.height = PALETTE_HEIGHT + 'px'
    b.textContent = 'WIRE'
    b.onclick = function () {
        model.brush = 'wire'
        each(radio_buttons, function (x) { x.style.background = 'grey' })
        this.style.background = 'gold'
    }
    radio_buttons.push(b)
    d.append(b)
    b.onclick()

    var b = document.createElement('button')
    b.style.width = PALETTE_HEIGHT + 'px'
    b.style.height = PALETTE_HEIGHT + 'px'
    b.textContent = 'OR'
    b.onclick = function () {
        model.brush = 'or_gate'
        each(radio_buttons, function (x) { x.style.background = 'grey' })
        this.style.background = 'gold'
    }
    radio_buttons.push(b)
    d.append(b)
    b.onclick()

    var b = document.createElement('button')
    b.style.width = PALETTE_HEIGHT + 'px'
    b.style.height = PALETTE_HEIGHT + 'px'
    b.textContent = 'AND'
    b.onclick = function () {
        model.brush = 'and_gate'
        each(radio_buttons, function (x) { x.style.background = 'grey' })
        this.style.background = 'gold'
    }
    radio_buttons.push(b)
    d.append(b)
    b.onclick()

    var b = document.createElement('button')
    b.style.width = PALETTE_HEIGHT + 'px'
    b.style.height = PALETTE_HEIGHT + 'px'
    b.textContent = 'NAND'
    b.onclick = function () {
        model.brush = 'nand_gate'
        each(radio_buttons, function (x) { x.style.background = 'grey' })
        this.style.background = 'gold'
    }
    radio_buttons.push(b)
    d.append(b)
    b.onclick()

    var b = document.createElement('button')
    b.style.width = PALETTE_HEIGHT + 'px'
    b.style.height = PALETTE_HEIGHT + 'px'
    b.textContent = 'delete'
    b.onclick = function () {
        model.brush = 'delete'
        each(radio_buttons, function (x) { x.style.background = 'grey' })
        this.style.background = 'gold'
    }
    radio_buttons.push(b)
    d.append(b)
    b.onclick()

    return d
}
document.body.append(draw_palette())

var c = document.createElement('canvas')
c.width = window.innerWidth
c.height = window.innerHeight - 50
var g = c.getContext('2d')
document.body.append(c)

function propagate() {
    model.version++
    var changes = {}
    
    each(model.wires, function (_, _key) {
        each([
            model.wires[_.x       + ',' + (_.y - 1)],
            model.wires[(_.x + 1) + ',' + _.y      ],
            model.wires[_.x       + ',' + (_.y + 1)],
            model.wires[(_.x - 1) + ',' + _.y      ]
        ], function (__) {
            if (__ && __.version > _.version) {
                changes[_key] = {
                    charge : __.charge,
                    version : __.version
                }
            }
        })
    })
    
    each(model.gates, function (_) {
        var high_count = 0
        var low_count = 0
        each([
            model.wires[(_.x + 0) + ',' + (_.y - 1)],
            model.wires[(_.x + 2) + ',' + (_.y - 1)],
            model.wires[(_.x + 3) + ',' + (_.y + 0)],
            model.wires[(_.x + 3) + ',' + (_.y + 2)],
            model.wires[(_.x + 0) + ',' + (_.y + 3)],
            model.wires[(_.x + 2) + ',' + (_.y + 3)],
            model.wires[(_.x - 1) + ',' + (_.y + 0)],
            model.wires[(_.x - 1) + ',' + (_.y + 2)]
        ], function (__) {
            if (__) {
                if (__.charge > 0) high_count++
                else low_count++
            }
        })
        var output = -1
        if (_.type == 'or_gate' && high_count > 0)
            output = 1
        if (_.type == 'and_gate' && low_count == 0)
            output = 1
        if (_.type == 'nand_gate' && high_count == 0)
            output = 1
        each([
            model.wires[(_.x + 1) + ',' + (_.y - 1)],
            model.wires[(_.x + 3) + ',' + (_.y + 1)],
            model.wires[(_.x + 1) + ',' + (_.y + 3)],
            model.wires[(_.x - 1) + ',' + (_.y + 1)]
        ], function (__) {
            if (__) {
                changes[__.x + ',' + __.y] = {
                    charge : output,
                    version : model.version
                }
            }
        })
    })
    
    each(changes, function (_, key) {
        model.wires[key].charge = _.charge
        model.wires[key].version = _.version
    })
}

function render() {
    g.fillStyle = 'rgba(0, 255, 0, 1)'
    g.fillRect(0, 0, c.width, c.height)

    var x_tiles = c.width / model.view.scale + 1
    var y_tiles = c.height / model.view.scale + 1
    
    g.beginPath()
    for (var y = 0; y < y_tiles; y++) {
        g.moveTo(0, y * model.view.scale + 0.5)
        g.lineTo(c.width, y * model.view.scale + 0.5)
    }
    for (var x = 0; x < x_tiles; x++) {
        g.moveTo(x * model.view.scale + 0.5, 0)
        g.lineTo(x * model.view.scale + 0.5, c.height)
    }
    g.strokeStyle = 'black'
    g.stroke()

    each(model.wires, function (_) {
        g.fillStyle = _.charge > 0 ? 'gold' : 'rgb(128, 128, 0)'
        g.fillRect(_.x * model.view.scale, _.y * model.view.scale, model.view.scale, model.view.scale)
    })

    each(model.gates, function (_) {
        g.fillStyle =
            (_.type == 'or_gate') ? 'orange' :
            (_.type == 'and_gate') ? 'blue' :
            (_.type == 'nand_gate') ? 'magenta' :
            'red'
        g.fillRect(_.x * model.view.scale, _.y * model.view.scale, model.view.scale * 3, model.view.scale * 3)
    })
}

var t_sum = 0
var t_count = 0

function loop() {
    
    var t0 = Date.now()
    
    propagate()
    render()
    
    var t1 = Date.now()
    t_sum += t1 - t0
    t_count += 1
    // console.log('time: ' + (t_sum / t_count))

    
    setTimeout(loop, 300)
}
loop()

c.onmousedown = function (e) {
    e.preventDefault()
    var old_pos = getRelPos(c, e)
    var moved = false

    var oldMove = document.onmousemove
    document.onmousemove = function (e) {
        var new_pos = getRelPos(c, e)
        moved = true
        
        old_pos = new_pos
    }
    
    var oldUp = document.onmouseup
    document.onmouseup = function (e) {
        document.onmousemove = oldMove
        document.onmouseup = oldUp

        if (!moved) {
            var new_pos = getRelPos(c, e)

            var x = Math.floor(new_pos.x / model.view.scale)
            var y = Math.floor(new_pos.y / model.view.scale)
            var key = x + ',' + y
            
            if (model.brush == 'wire') {
                model.wires[key] = {
                    x : x,
                    y : y,
                    charge : -1,
                    version : 0
                }
            } else if (model.brush == 'delete') {
                delete model.wires[key]
                delete model.gates[key]
            } else {
                model.gates[key] = {
                    x : x,
                    y : y,
                    type : model.brush
                }
            }
            
            db.child('/aa/test_node/logicland002').set(model)

            render()
        }
    }
}

function getPos(e) {
    var x = 0, y = 0
    while (e != null) {
        x += e.offsetLeft
        y += e.offsetTop
        e = e.offsetParent
    }
    return {x : x, y : y}
}

function getRelPos(to, positionedObject) {
    var pos = getPos(to)
    return {
        x : positionedObject.pageX - pos.x,
        y : positionedObject.pageY - pos.y
    }
}


function each(o, cb) {
	if (o instanceof Array) {
		for (var i = 0; i < o.length; i++) {
			if (cb(o[i], i, o) == false)
				return false
		}
	} else {
		for (var k in o) {
			if (o.hasOwnProperty(k)) {
				if (cb(o[k], k, o) == false)
					return false
			}
		}
	}
	return true
}

</script>
