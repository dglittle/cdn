
<body></body>
<script>
    

function create_uvsync() {
    var self = {
        // {id, ins:text or del:num or collapse:[], aft, pos, (bef) }
        op_set : {
            'void' : true
        },
        
        // {id, ins:text ..., off, len}
        op_arr : [{
            id : 'void',
            ins : '',
            off : 0,
            len : 0
        }],
        
        text : ''
    }
    
    self.add_op = function (op) {
        self.op_set[op.id] = op
        if (op.del) {
            // find place to delete..
            var offset = 0
            for (var i = 0; i < self.op_arr.length; i++) {
                var o = self.op_arr[i]
                if (o.id == op.aft) {
                    if (op.pos < o.off + o.len) {
                        if (op.pos > o.off) {
                            var len = op.pos - o.off
                            self.op_arr.splice(i + 1, 0, {
                                id : o.id,
                                ins : o.ins.substr(len),
                                off : o.off + len,
                                len : o.len - len
                            })
                            o.ins = o.substr(0, len)
                            o.len -= len
                            o = self.op_arr[++i]
                            
                            op = extend({}, op)
                            op.pos += len
                            op.del -= len
                            offset += len
                        }
                        if (op.pos == o.off && (op.pos + op.del <= o.off + o.len)) {
                            if (op.pos + op.del < o.off + o.len) {
                                self.op_arr.splice(i, 0, {
                                    id : o.id,
                                    ins : '',
                                    off : o.off,
                                    len : op.del
                                })
                            }
                            o.off += op.del
                            o.len -= op.del
                            o.ins = o.ins.substr(op.del)
                            self.text = self.text.slice(0, offset) +
                                self.text.slice(offset + op.del)
                            return
                        }
                    }
                }
                offset += o.ins.length
            }
        } else if (op.ins) {
            op = extend({}, op)
            op.off = 0
            op.len = op.ins.length
            var offset = 0
            for (var i = 0; i < self.op_arr.length; i++) {
                var o = self.op_arr[i]
                if (o.id == op.aft) {
                    if (op.pos <= o.off + o.len) {
                        var rest = o.ins.substr(op.pos - o.off)
                        o.ins = o.ins.substr(0, op.pos - o.off)
                        o.len = o.ins.length
                        var ii = i + 1
                        if (rest == '') {
                            var oo = self.op_arr[ii]
                            while (oo.aft == o.id) {
                                if (op.id > oo.id && oo.id != op.bef) {
                                    while (oo.id != o.id) {
                                        oo = self.op_arr[++ii]
                                    }
                                    oo = self.op_arr[++ii]
                                } else break
                            }
                        }
                        self.op_arr.splice(ii, 0, op)
                        self.text = self.text.slice(0, offset) + op.ins +
                            self.text.slice(offset)
                        self.op_arr.splice(ii + 1, 0, {
                            id : o.id,
                            ins : rest,
                            off : o.off + o.len,
                            len : rest.length
                        })
                        return
                    }
                }
                offset += o.ins.length
            }
        }
    }
    
    return self
}
    
</script>
