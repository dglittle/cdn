
<script src="https://dglittle.github.io/cdn/random001.js"></script>
<script src="https://dglittle.github.io/cdn/utils004.js"></script>
<script src="https://invisible-college.github.io/universal-sync/diffsync.js"></script>
<script>

Math.randomSeed(7)

function create_sync7_repo() {
    return {
        commits : {
            'root' : { to_parents : {} }
        },
        temp_commits : {},
        leaf : 'root',
        text : ''
    }
}

function sync7_diff_merge_trans(a, b, a_factor, b_factor) {
    var ret = []
    var a_i = 0
    var b_i = 0
    var a_offset = 0
    var b_offset = 0
    function neg_idx(i) {
        return i == 0 ? 1 : 0
    }
    function a_idx(i) {
        return a_factor == -1 ? neg_idx(i) : i
    }
    function b_idx(i) {
        return b_factor == -1 ? neg_idx(i) : i
    }
    while (a_i < a.length && b_i < b.length) {
        var da = a[a_i]
        var db = b[b_i]
        if (typeof(da) == 'number' && typeof(db) == 'number') {
            var a_len = da - a_offset
            var b_len = db - b_offset
            sync7_push_eq(ret, Math.min(a_len, b_len))
        } else if (typeof(da) == 'number') {
            var a_len = da - a_offset
            var b_len = db[b_idx(0)].length - b_offset
            sync7_push_rep(ret, db[b_idx(0)].substr(b_offset, Math.min(a_len, b_len)), b_offset == 0 ? db[b_idx(1)] : '')
        } else if (typeof(db) == 'number') {
            var a_len = da[a_idx(1)].length - a_offset
            var b_len = db - b_offset
            sync7_push_rep(ret, a_offset == 0 ? da[a_idx(0)] : '', da[a_idx(1)].substr(a_offset, Math.min(a_len, b_len)))
        } else {
            var a_len = da[a_idx(1)].length - a_offset
            var b_len = db[b_idx(0)].length - b_offset
            sync7_push_rep(ret, a_offset == 0 ? da[a_idx(0)] : '', b_offset == 0 ? db[b_idx(1)] : '')
        }
        if (a_len > b_len) {
            a_offset += b_len
        } else {
            a_i++
            a_offset = 0
        }
        if (a_len < b_len) {
            b_offset += a_len
        } else {
            b_i++
            b_offset = 0
        }
    }
    while (a_i < a.length) {
        var da = a[a_i]
        if (typeof(da) == 'number') {
            sync7_push_eq(ret, da)
        } else {
            sync7_push_rep(ret, a_offset == 0 ? da[a_idx(0)] : '', da[a_idx(1)].substr(a_offset))
        }
        a_i++
        a_offset = 0
    }
    while (b_i < b.length) {
        var db = b[b_i]
        if (typeof(db) == 'number') {
            sync7_push_eq(ret, db)
        } else {
            sync7_push_rep(ret, db[b_idx(0)].substr(b_offset), b_offset == 0 ? db[b_idx(1)] : '')
        }
        b_i++
        b_offset = 0
    }
    return ret
}

function sync7_intersection(a, b) {
    var common = {}
    each(a, function (_, x) {
        if (b[x]) {
            common[x] = a[x]
        }
    })
    return common
}

function sync7_diff(a, b) {
    var ret = []
    var d = diff_main(a, b)
    for (var i = 0; i < d.length; i++) {
        var top = ret[ret.length - 1]
        if (d[i][0] == 0) {
            ret.push(d[i][1].length)
        } else if (d[i][0] == 1) {
            if (top && (typeof(top) != 'number'))
                top[1] += d[i][1]
            else
                ret.push(['', d[i][1]])
        } else {
            if (top && (typeof(top) != 'number'))
                top[0] += d[i][1]
            else
                ret.push([d[i][1], ''])
        }
    }
    return ret
}

function sync7_diff_apply(s, diff) {
    var offset = 0
    var texts = []
    each(diff, function (d) {
        if (typeof(d) == 'number') {
            texts.push(s.substr(offset, d))
            offset += d
        } else {
            texts.push(d[1])
            offset += d[0].length
        }
    })
    texts.push(s.substr(offset))
    return texts.join('')
}

var repoA = create_sync7_repo()
var repoB = create_sync7_repo()
var c_x = sync7_commit(repoA, 'x')
// sync7_merge(repoB, c_x, my_custom_merge_func)
// var c_xz = sync7_commit(repoA, 'xz')
// var c_y = sync7_commit(repoB, 'y')
// sync7_merge(repoA, c_y, my_custom_merge_func)
// var c_q = sync7_commit(repoB, 'q')
// sync7_merge(repoB, c_xz, my_custom_merge_func)
// var c_yzA = sync7_commit(repoA, 'yzA')
// var c_qzB = sync7_commit(repoB, 'qzB')
// sync7_merge(repoA, c_q, my_custom_merge_func)
// sync7_merge(repoA, c_qzB, my_custom_merge_func)
console.log(JSON.stringify(repoA, null, '    '))

</script>
