
<script src="https://dglittle.github.io/cdn/random001.js"></script>
<script src="https://dglittle.github.io/cdn/utils004.js"></script>
<script src="https://invisible-college.github.io/universal-sync/diffsync.js"></script>
<body></body>
<script>

/*

var db = sync9_create_client(url)
db.on(key, (proxy_value) => {
    proxy_value.x = 5
})

*/

function sync9_create_client(url) {
    var ws = null
    var keys = {}
    
    function send(o) {
        try {
            ws.send(JSON.stringify(o))
        } catch (e) {}
    }

    window.addEventListener('beforeunload', () => {
        send({ close : true })
    })

    function reconnect() {
        ws = new WebSocket(url)

        var pong_timer = null
        function on_pong() {
            clearTimeout(pong_timer)
            setTimeout(() => {
                send({ ping : true })
                pong_timer = setTimeout(reconnect, 4000)
            }, 3000)
        }
        
        ws.onopen = () => {
            on_pong()
            Object.keys(keys).forEach(k => send({ on : k }))
        }
        ws.onclose = reconnect
        ws.onmessage = (e) => {
            var o = JSON.parse(e.data)
            if (o.pong) return on_pong()

            console.log('message: ' + e.data)
            
            if (o.init) {
                
            }
        }
    }
    reconnect()
    
    return {
        on : (key, cb) => {
            keys[key] = {
                s9 : sync9_create(),
                unACKed_versions : {},
                cb : cb
            }
            send({ on : key })
        },
        off : key => {
            delete keys[key]
            send({ off : key })
        },
        close : () => send({ close : true })
    }
}

function sync9_guid() {
    var x = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ'
    var s = []
    for (var i = 0; i < 15; i++)
        s.push(x[Math.floor(Math.random() * x.length)])
    return s.join('')
}

sync9_create_client('ws://localhost:60608')

</script>
