
function worldA() {
    var c = document.createElement('canvas')
    c.width = window.innerWidth
    c.height = window.innerHeight
    var g = c.getContext('2d')
    
    for (var x = 0; x < c.width; x += 256) {
        g.moveTo(x + 0.5, 0)
        g.lineTo(x + 0.5, c.height)
    }
    for (var x = 0; x < c.width; x += 256) {
        g.moveTo(0, x + 0.5)
        g.lineTo(c.height, x + 0.5)
    }
    g.stroke()
    
    document.body.append(c)
    
    var img = document.createElement('img')
    img.src = 'http://dglittle.github.io/cdn/penrose002.png'
    img.style.position = 'absolute'
    img.style.left = '256px'
    img.style.top = '0px'
    img.onclick = function () {
        window.parent.location.href = 'https://dglittle.github.io/cdn/penrose001.html'
    }
    document.body.append(img)
    
    var chat = document.createElement('iframe')
    chat.frameBorder = '0'
    chat.src = 'https://dglittle.github.io/cdn/chat001.html'
    chat.style.position = 'absolute'
    chat.style.left = '0px'
    chat.style.top = '0px'
    chat.style.width = '256px'
    chat.style.height = '256px'
    document.body.append(chat)
    
    var x = document.createElement('iframe')
    x.frameBorder = '0'
    x.src = 'https://dglittle.github.io/cdn/xymodel001.html'
    x.style.position = 'absolute'
    x.style.left = '0px'
    x.style.top = '256px'
    x.style.width = '256px'
    x.style.height = '256px'
    document.body.append(x)
    var x = document.createElement('div')
    x.style.position = 'absolute'
    x.style.left = '0px'
    x.style.top = '256px'
    x.style.width = '256px'
    x.style.height = '256px'
    x.onclick = function () {
        window.parent.location = 'https://dglittle.github.io/cdn/view001.html#xymodel001.html'
    }
    document.body.append(x)
    
    function drawFlashlight001() {
        var x = document.createElement('button')
        x.style.position = 'absolute'
        x.style.left = '256px'
        x.style.top = '256px'
        x.style.width = '128px'
        x.style.height = '128px'
        x.textContent = 'download simple android flashlight app/widget\n\uD83D\uDD26'
        x.onclick = function () {
            window.location.href = 'https://dglittle.github.io/flashlight001/app/release/app-release.apk'
        }
        document.body.append(x)
    }
    drawFlashlight001()
}

var each = function (o, cb) {
	if (o instanceof Array) {
		for (var i = 0; i < o.length; i++) {
			if (cb(o[i], i, o) == false)
				return false
		}
	} else {
		for (var k in o) {
			if (o.hasOwnProperty(k)) {
				if (cb(o[k], k, o) == false)
					return false
			}
		}
	}
	return true
}

var login = function () {
    firebase.auth().signInWithRedirect(new firebase.auth.GoogleAuthProvider())
}

var print = function (x) {
    var d = document.createElement('div')
    d.innerHTML = x
    document.body.appendChild(d)
}

// include('blah.com', 'bloop.com', function () { then do this })
var include = function () {
    var args = arguments
    var i = 0
    function do_next() {
        if (i < args.length - 1) {
            var x = document.createElement('script')
            document.head.appendChild(x)
            x.onload = do_next
            i = i + 1
            x.src = args[i - 1]
        } else {
            args[args.length - 1]()
        }
    }
    do_next()
}

var on_ace_load_cbs = []
var require_ace = function (cb) {
    if (!on_ace_load_cbs) {
        cb()
    } else {
        on_ace_load_cbs.push(cb)
        if (on_ace_load_cbs.length == 1) {
            include('https://cdn.jsdelivr.net/ace/1.2.6/min/ace.js', 'https://cdn.jsdelivr.net/ace/1.2.6/min/ext-language_tools.js', function () {
                each(on_ace_load_cbs, function (x) { x() })
                on_ace_load_cbs = null
            })
        }
    }
}

var edit = function (db_path) {
    db.child(db_path).once('value', function (x) {
        var text = x.val() || ''
        require_ace(function () {
            editForReal(db_path, text)
        })
    })
}

var editForReal = function (db_path, text) {
    while (document.body.firstChild) {
        document.body.removeChild(document.body.firstChild)
    }

    var input = document.createElement('div')
    input.id = 'input'
    input.style.position = 'absolute'
    input.style.top = '0px'
    input.style.left = '0px'
    input.style.width = '50%'
    input.style.height = '100%'
    document.body.appendChild(input)

    ace.require('ace/ext/language_tools')
    var editor = ace.edit('input')
    editor.setTheme('ace/theme/monokai')
    editor.renderer.setShowGutter(false)
    editor.setShowPrintMargin(false)
    editor.setShowFoldWidgets(false)
    editor.setOptions({
        fontFamily: 'Menlo,monospace',
        fontSize: '9pt',
        wrap: true,
        enableBasicAutocompletion: true,
        enableLiveAutocompletion: true
    })
    editor.getSession().setMode('ace/mode/javascript')

    editor.getSession().setValue(text)

    document.body.onkeydown = function (e) {
        if ((e.shiftKey || e.ctrlKey || e.metaKey) && ((e.keyCode == 83 && !e.shiftKey) || e.keyCode == 13)) {
            e.preventDefault()
            var x = editor.getSession().getValue()
            db.child(db_path).set(x, function () {
                reload_iframe()
            })
        }
    }

    var frame = null
    function reload_iframe() {
        if (frame) frame.remove()
        frame = document.createElement('iframe')
        frame.frameBorder = '0'
        frame.style.position = 'absolute'
        frame.style.left = '50%'
        frame.style.top = '0px'
        frame.style.width = '50%'
        frame.style.height = '100%'
        frame.src = 'https://glittle.org' + db_path
        document.body.appendChild(frame)
    }
    reload_iframe()
}

function show_in_frame(src) {
    var f = document.createElement('iframe')
    f.frameBorder = 0
    f.src = src
    f.style.position = 'absolute'
    f.style.width = '100%'
    f.style.height = '100%'
    document.body.appendChild(f)
}

document.body.style.margin = 0
document.body.style.padding = 0
var pathname = location.pathname
if (pathname == '/') pathname = '/run_me'

console.log('path: '+ pathname)

if (pathname.startsWith('/aa/andy')) {
    show_in_frame('https://dglittle.github.io/cdn/andy001.html')
} else if (pathname.startsWith('/aa/mom')) {
    show_in_frame('https://dglittle.github.io/cdn/mom001.html')
} else if (pathname.startsWith('/aa/dad')) {
    window.addEventListener('message', function (e) {
        if (e.origin == 'https://dglittle.github.io' && typeof(e.data) == 'object') {
            if (e.data.cmd == 'get_url') {
                var url = ''
                try {
                    url = localStorage.getItem('url')
                } catch (e) {}
                e.source.postMessage(url, e.origin)
            } else if (e.data.cmd == 'set_url') {
                localStorage.setItem('url', e.data.url)
            }
        }
    }, false)
    show_in_frame('https://dglittle.github.io/cdn/dad001.html')
} else if (pathname.startsWith('/aa/penrose')) {
    show_in_frame('https://dglittle.github.io/cdn/penrose001.html')
} else if (pathname.startsWith('/aa/luke')) {
    show_in_frame('https://dglittle.github.io/cdn/lukeedit001.html')
} else if (pathname.startsWith('/diff')) {
    show_in_frame('https://dglittle.github.io/cdn/diff001.html')
} else if (location.search == '?edit') {
    edit(pathname)
} else {
    if (pathname == '/run_me') {
        if (window.self == window.top) {
            edit(pathname)
        } else {
            worldA()
        }
        // var prev = 'hello world! under construction...'
        // print(prev)
        // loop()
    } else {
        db.child(pathname).once('value', function (x) {
            x = x.val()
            if (x) {
                try {
                    eval(x)
                } catch (e) {
                    console.log(e)
                    print(x)
                }
            } else {
                print("there's no code at location: " + pathname)
                loop()
            }
        })
    }
}
