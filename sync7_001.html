
<script src="https://dglittle.github.io/cdn/utils004.js"></script>
<script src="https://invisible-college.github.io/universal-sync/diffsync.js"></script>
<script>

console.log('hi 3!')

function intersection(a, b) {
    var common = {}
    each(a, function (_, x) {
        if (b[x]) {
            common[x] = a[x]
        }
    })
    return common
}

function create_sync7_repo() {
    var self = {
        commits : {},
        leaves : {},
        text : ''
    }

    self.commit = function (s) {
        if (s == self.text) { return }

        var c = {
            to_parents : {},
            from_parents : {},
            text : s
        }
        each(self.leaves, function (_, leaf) {
            c.from_parents[leaf] = get_diff_patch(self.commits[leaf].text, s)
            c.to_parents[leaf] = true
        })

        var id = guid()
        self.commits[id] = c
        self.leaves = {}
        self.leaves[id] = true
        self.text = s

        var cs = {}
        cs[id] = c
        return cs
    }

    self.merge = function (cs) {
        each(cs, function (c, id) {
            self.commits[id] = c
        })
        self.leaves = self.get_leaves()
        var leaves = Object.keys(self.leaves)
        if (leaves.length > 1) {
            var ancestors = self.get_ancestors(leaves[0])
            for (var i = 1; i < leaves.length; i++) {
                var i_ancestors = self.get_ancestors(leaves[i])
                var LCAs = self.get_leaves(intersection(ancestors, i_ancestors))
                
                
            }
        }
        
        
        // get least common ancestors of the leaves
        
        self.text = 'MERGE: ' + Object.keys(self.leaves)
        
        
        return self.text
    }
    
        var r_ancestors = self.get_ancestors(these[0])
        for (var i = 1; i < these.length; i++) {
            var i_ancestors = self.get_ancestors(these[i])
            var o = self.rec_merge(self.get_leaves(intersection(r_ancestors, i_ancestors)))
            r = apply_diff_patch(o, get_merged_diff_patch(r, self.get_text(these[i]), o))
            extend(r_ancestors, i_ancestors)
        }
        return r
    }
    
    self.get_leaves = function (commits) {
        if (!commits) commits = self.commits
        var leaves = {}
        each(commits, function (_, id) { leaves[id] = true })
        each(commits, function (c) {
            each(c.to_parents, function (_, p) {
                delete leaves[p]
            })
        })
        return leaves
    }
    
    self.get_ancestors = function (id) {
        var frontier = [id]
        var ancestors = {}
        while (frontier.length > 0) {
            var next = frontier.shift()
            each(self.commits[next].to_parents, function (_, p) {
                if (!ancestors[p]) {
                    ancestors[p] = self.commits[p]
                    frontier.push(p)
                }
            })
        }
        return ancestors
    }

    return self
}

var repoA = create_sync7_repo()
var repoB = create_sync7_repo()

repoA.commit('hiA')
repoA.merge(repoB.commit('hiB'))

console.log(JSON.stringify(repoA))

</script>
