<script src="https://www.gstatic.com/firebasejs/4.8.1/firebase.js"></script>
<script src="https://dglittle.github.io/cdn/random001.js"></script>

<body style="margin:0px;padding:0px">
<div style="width:100%;height:100%;display:grid;grid-template-rows:1fr auto;background:rgb(5, 10, 20)">
    <div id="chat_messages" style="width:100%;height:100%"></div>
    <input id="input_box" value="hi there" placeholder="your message"></input>
</div>
</body>

<script>

var config = {
    apiKey: "AIzaSyDVM0ekHwUqC_rGsqkT7fJ71FyRum9cxko",
    authDomain: "glittle.firebaseapp.com",
    databaseURL: "https://glittle.firebaseio.com",
    projectId: "glittle",
    storageBucket: "",
    messagingSenderId: "1000468536093"
}
var db = firebase.initializeApp(config).database().ref()
var uid = null

function shuffle(a) {
    for (var i = 0; i < a.length; i++) {
        var ri = Math.floor(a.length * Math.random())
        var temp = a[i]
        a[i] = a[ri]
        a[ri] = temp
    }
    return a
}

function random_color(seed) {
    Math.randomSeed(seed)
    return 'rgb(' + shuffle([Math.floor(Math.random() * 256), 255, 0]).join(', ') + ')'
}

function run_chat() {
    function display_chat_message(x) {
        var d = document.createElement('div')
        d.textContent = x.uid + ' : ' + x.text
        d.style.color = random_color(x.uid)
        window.chat_messages.append(d)
    }
    db.child('/aa/chat').on('child_added', function (x) {
        x = x.val()
        if (x) {
            display_chat_message(x)
        }
    })
}

window.input_box.onkeydown = function (e) {
    if (!uid) return;
    if ((e.shiftKey || e.ctrlKey || e.metaKey) && ((e.keyCode == 83 && !e.shiftKey) || e.keyCode == 13)) {
        e.preventDefault()
        var ref = db.child('/aa/chat').push()
        ref.set({
            uid : uid,
            text : window.input_box.value,
            time : firebase.database.ServerValue.TIMESTAMP
        })
    }
}

firebase.auth().onAuthStateChanged(function(user) {
    if (user) {
        uid = user.uid
        run_chat()
    }
})
firebase.auth().signInAnonymously().catch(function(error) {
    console.log(error)
})

</script>
