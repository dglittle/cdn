
<script src="https://invisible-college.github.io/diffsync/diffsync.js"></script>

<script type="statebus">

resizebox = (target) ->
  target.style.height = null
  while(target.rows > 1 && target.scrollHeight < target.offsetHeight)
    target.rows--
  while(target.scrollHeight > target.offsetHeight)
    target.rows++
    

diffsyncs = {}

addDiffSyncToTextArea = (t, channel) ->
  ds = diffsyncs[channel]
  if !ds
    ds = diffsyncs[channel] = `{ options : {} }`
  else
    t.value = ds.prev_t.value
    t.setSelectionRange(ds.prev_t.selectionStart, ds.prev_t.selectionEnd)
  ds.prev_t = t
  ds.options.ws_url = 'wss://invisible.college:' + diffsync.port
  ds.options.channel = channel
  ds.options.get_text = -> t.value
  ds.options.get_range = -> [t.selectionStart, t.selectionEnd]
  ds.options.on_text = (text, range) ->
    t.value = text
    console.log('CURSOR POS: ' + range[0] + ',' + range[1])
    t.setSelectionRange(range[0], range[1])
  if !ds.client
    ds.client = diffsync.create_client(ds.options)

  t.onkeyup = ->
    ds.client.on_change()
    resizebox(t)
  t.onpaste = ->
    setTimeout(->
      ds.client.on_change()
      resizebox(t)
    , 0)

dom.SYNCAREA = ->
  @props.style.resize = if @props.style.width or @props.cols then 'none' else 'horizontal'
  TEXTAREA
    ref: 'textbox'
    rows: 1
    cols: @props.cols
    placeholder: @props.placeholder
    className: @props.className
    style: @props.style

dom.SYNCAREA.up = ->
  addDiffSyncToTextArea(@refs.textbox.getDOMNode(), @props.key_)
  resizebox(@refs.textbox.getDOMNode())

dom.SYNCAREA.refresh = ->
  addDiffSyncToTextArea(@refs.textbox.getDOMNode(), @props.key_)
  resizebox(@refs.textbox.getDOMNode())



dom.BODY = ->
  size = if state.big then 300 else 50
  DIV
    backgroundColor: 'green'
    DIV
      width: size
      height: size
      padding: 20
      backgroundColor: 'lightgrey'
      onClick: => state.big = !state.big
      'Click me!'
    SYNCAREA
      key_: 'some-test-7644995'
      placeholder: 'Blah'
      style:
        width: '100%'
        backgroundColor: 'lightgreen'
        outline: 'none'
        padding: '0.5em'
        borderRadius: '4px 4px 4px 4px'  
</script>

<script src="https://stateb.us/client6.js" server="https://stateb.us:3006"></script>
